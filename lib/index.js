!function(t,e){for(var n in e)t[n]=e[n]}(exports,function(t){var e={};function n(s){if(e[s])return e[s].exports;var i=e[s]={i:s,l:!1,exports:{}};return t[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(s,i,function(e){return t[e]}.bind(null,i));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=n(1);Object.defineProperty(e,"Dialog",{enumerable:!0,get:function(){return s.Dialog}})},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Dialog=void 0;const s=n(2),i=n(3),r=n(4),o=n(5);class a{constructor({scenes:t,state:e,whatCanYouDo:n}){this.scenes=new Map,this.transitions=new Map,this.initialState=e,this.whatCanYouDoHandler=null!=n?n:()=>{};for(let e of Object.keys(t)){const n=t[e];if(this.isScene(n))this.scenes.set(e,new i.SceneProcessor(n.onInput,n.reply,n.help,n.unrecognized));else{if(!this.isTransition(n))throw new Error(`Элемент ${e} не был распознан ни как сцена ни как переход.`);this.transitions.set(e,new o.TransitionProcessor(n.onTransition,n.reply))}}}static create(t){return new a({state:()=>({}),...t})}handleRequest(t){return this.isPingRequest(t)?this.handlePing():this.handleUserRequest(t)}isPingRequest(t){return t.request.original_utterance.includes("ping")}handlePing(){return Promise.resolve({response:{text:"pong",end_session:!0},version:"1.0"})}async handleUserRequest(t){var e;const{command:n,nlu:{intents:i}}=t.request,o=new s.ReplyBuilder,a=this.getOrCreateSessionState(t),l=null!==(e=this.findTransition(a.$currentScene))&&void 0!==e?e:this.getScene(a.$currentScene);if(t.session.new&&l.hasReply())return await this.applyTransitionsAndScene(a,o);const u=this.getScene(a.$currentScene),c={command:n.toLowerCase(),intents:i,request:t,isConfirm:i&&i.hasOwnProperty(r.DialogBuildinIntent.Confirm),isReject:i&&i.hasOwnProperty(r.DialogBuildinIntent.Reject)};if(i){if(c.intents[r.DialogBuildinIntent.Help])return u.applyHelp(o,a.state),o.build(a);if(c.intents[r.DialogBuildinIntent.WhatCanYouDo])return this.whatCanYouDoHandler(o,a.state),u.applyHelp(o,a.state),o.build(a);if(c.intents[r.DialogBuildinIntent.Repeat])return u.applyReply(o,a.state),o.build(a)}const d=await u.applyInput(c,a.state);return d.$currentScene?(this.assertSessionHasSceneId(d),await this.applyTransitionsAndScene(d,o)):(u.applyUnrecognized(o,a.state),o.build({state:d.state,$currentScene:a.$currentScene}))}getOrCreateSessionState(t){const e=t.state&&t.state.session;return this.isNotEmptySessionState(e)?e:{state:this.initialState(),$currentScene:"Start"}}async applyTransitionsAndScene(t,e){const n=await this.applyTransitions(t,e);return this.getScene(n.$currentScene).applyReply(e,n.state),e.build(n)}async applyTransitions(t,e){const n=this.findTransition(t.$currentScene);return n?(n.applyReply(e,t.state),this.applyTransitions(await n.applyTransition(t.state),e)):t}findTransition(t){return this.transitions.get(t)}getScene(t){const e=this.scenes.get(t);if(!e)throw new Error(`Сцена ${t} не определена.`);return e}isNotEmptySessionState(t){return t&&"$currentScene"in t&&"state"in t}isScene(t){return"function"==typeof t.onInput}isTransition(t){return"function"==typeof t.onTransition}assertSessionHasSceneId(t){if("string"!=typeof t.$currentScene)throw new Error("sessionState не содержит sceneId")}}e.Dialog=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ReplyBuilder=void 0;e.ReplyBuilder=class{constructor(){this.text="",this.tts="",this.endSession=!1,this.buttons=[]}get buttonsCount(){return this.buttons.length}withText(...t){for(const e of t)this.addSpace(e),Array.isArray(e)?(this.text+=e[0],this.tts+=e[1]):(this.text+=e,this.tts+=e)}withTts(...t){for(const e of t)this.addSpaceToTts(),this.tts+=e}withTextPluralized(t,e,n,s){const i=t%10==1&&t%100!=11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2;this.withText([e,n,s][i])}withEndSession(){this.endSession=!0}withButton(t){"string"==typeof t?this.buttons.push({title:t}):this.buttons.push(t)}withImage(t){if(this.imageId)throw new Error("Изображение уже задано.");this.imageId=t}selectRandom(t,e,n=1){if(0===n||0===e.length)return;const s=e[Math.floor(Math.random()*e.length)];t(s),this.selectRandom(t,e.filter(t=>t!==s),n-1)}build(t){const e=this.imageId?{type:"BigImage",image_id:this.imageId,description:this.text.substr(0,255)}:void 0;return{response:{text:this.text,tts:this.tts,card:e,end_session:this.endSession,buttons:this.buttons.map(t=>({title:t.title,url:t.url,hide:!0}))},session_state:t,version:"1.0"}}addSpace(t){const e=(Array.isArray(t)?t[0]:t).toString();!this.text||this.text.endsWith(" ")||e.startsWith(",")||e.startsWith(".")||(this.text+=" "),this.addSpaceToTts()}addSpaceToTts(){this.tts&&!this.tts.endsWith(" ")&&(this.tts+=" ")}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SceneProcessor=void 0;e.SceneProcessor=class{constructor(t,e,n,s){this.inputHandler=t,this.replyHandler=e,this.helpHandler=n,this.unrecognizedHandler=s,this.applyReply=(t,e)=>{this.replyHandler&&this.replyHandler(t,e)},this.applyHelp=(t,e)=>{var n,s;const i=null!==(s=null!==(n=this.helpHandler)&&void 0!==n?n:this.unrecognizedHandler)&&void 0!==s?s:this.replyHandler;i&&i(t,e)},this.applyUnrecognized=(t,e)=>{var n,s;const i=null!==(s=null!==(n=this.unrecognizedHandler)&&void 0!==n?n:this.helpHandler)&&void 0!==s?s:this.replyHandler;i&&i(t,e)}}hasReply(){return Boolean(this.replyHandler)}async applyInput(t,e){const n=[],s=await this.inputHandler(t,e,t=>n.push(t));return{state:Object.assign({},e,...n),$currentScene:s}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DialogBuildinIntent=void 0,function(t){t.Confirm="YANDEX.CONFIRM",t.Reject="YANDEX.REJECT",t.Help="YANDEX.HELP",t.Repeat="YANDEX.REPEAT",t.WhatCanYouDo="YANDEX.WHAT_CAN_YOU_DO"}(e.DialogBuildinIntent||(e.DialogBuildinIntent={}))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TransitionProcessor=void 0;e.TransitionProcessor=class{constructor(t,e){this.transitionHandler=t,this.replyHandler=e,this.applyReply=(t,e)=>{this.replyHandler&&this.replyHandler(t,e)}}hasReply(){return Boolean(this.replyHandler)}async applyTransition(t){const e=[],n=await this.transitionHandler(t,t=>e.push(t));return{state:Object.assign({},t,...e),$currentScene:n}}}}]));